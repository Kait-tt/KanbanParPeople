<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title><%= title %></title>
    <link rel='stylesheet' href='/stylesheets/kanban.css'/>
    <link rel='stylesheet' href='/vendor/bootstrap-switch/dist/css/bootstrap3/bootstrap-switch.min.css'/>
</head>
<body>

<% include _header %>

<div class="main" data-bind="visible: true" style="display: none">
    <div class="project-meta">
        <h1 class="project-name"><%= displayTitle %></h1>
        <div class="sync-status">
            <!-- ko if: $root.project.github().sync -->
            <span class="label label-primary">同期ON</span>
            <!-- /ko -->
            <!-- ko ifnot: $root.project.github().sync -->
            <span class="label label-default">同期OFF</span>
            <!-- /ko -->
        </div>
        <button type="button" class="btn btn-sm btn-default project-settings-button"
                data-toggle="modal" data-target="#project-settings-modal">
            <span class="glyphicon glyphicon-cog" area-hidden="true"></span> Settings
        </button>
        <button type="button" class="btn btn-sm btn-default members-settings-button"
                data-toggle="modal" data-target="#members-settings-modal">
            <span class="glyphicon glyphicon-user" area-hidden="true"></span> Members
        </button>
    </div>

    <div class="blocks">
        <ul class="stage-blocks">
            <% stages.forEach(function (stage) { %>
                <% if(stage.name == 'todo'){ %>
                    <li id="three-stage-blocks">
                        <ul class="inner-stage-blocks">
                        
                <% } %>
                <li id="<%= stage.name %>-block" class="stage-block">
                    <h2 class="stage-title">
                        <%= stage.displayName %><span class="badge" data-bind="text: $root.stages.<%= stage.name %>().length"></span>
                    </h2>

                    <% if (stage.name === 'issue') { %>
                        <div class="block-header issue-block-header">
                            <button type="button" class="btn btn-sm btn-default"
                                    data-toggle="modal" data-target="#add-issue-modal">
                                <span class="glyphicon glyphicon-credit-card" aria-hidden="true"></span> Add task
                            </button>
                        </div>
                    <% } else { %>
                        <div class="block-header block-header-dummy"></div>
                    <% } %>

                    <% if (stage.assigned) { %>
                        <ul class="cell-block" data-bind="foreach: {
                            data: members,
                            afterRender: view.MiniMenu.init,
                            afterAdd: view.effects.slideDown,
                            beforeRemove: view.effects.slideUp }">
                            <li class="dummy-user-cell-block" data-bind="visible: visible"></li>
                        </ul>
                    <% } else { %>
                        <ul class="cell-block" data-bind="
                        foreach: {
                            data: $root.stages.<%= stage.name %>,
                            afterRender: view.MiniMenu.init,
                            afterAdd: view.effects.slideDown,
                            beforeRemove: view.effects.slideUp }">
                            <% include _card %>
                        </ul>
                    <% } %>
                </li>
                <% if(stage.name == 'review'){ %>
                    </ul>
                    <div class="user-block-area">
                    <div class="block-header user-area-header"></div>

                    <ul class="user-blocks" data-bind="foreach: {
                            data: members,
                            as: 'member',
                            afterAdd: view.effects.slideDown,
                            beforeRemove: view.effects.slideUp }">
                        <li class="user-block" data-bind="css: { 'wip-limited': member.isWipLimited }, visible: member.visible">
                            <div class="user-label-area">
                                <p class="user-name">
                                    <a href="#" class="user-settings-button"
                                       data-toggle="modal" data-target="#user-settings-modal"
                                       data-bind="click: $root.selectedMember">
                                        <span class="glyphicon glyphicon-cog" area-hidden="true"></span>
                                    </a>
                                    <span data-bind="text: userName"></span>
                                    <span data-bind="text: '(' + member.wip() + '/' + member.wipLimit() + ')'"></span>
                                </p>

                                <p class="wip-limited-message alert-warning" data-bind="visible: member.isWipLimited">
                                    <span class="glyphicon glyphicon-warning-sign"></span>WIP制限に達しています。
                                </p>
                            </div>

                            <ul class="stage-blocks" data-bind="foreach: { data: <%= assignedStageNamesJSON %>, as: 'stage' }">
                                <li class="stage-block">
                                    <div class="user-cell-block">
                                        <ul class="card-list" data-bind="
                                        foreach: {
                                            data: member[stage]().slice(0, 2),
                                            afterRender: view.MiniMenu.init,
                                            afterAdd: view.effects.slideDown,
                                            beforeRemove: view.effects.slideUp }">
                                            <% include _card %>
                                        </ul>

                                        <a href="#" class="each-all-issues-view-button" data-bind="
                                        click: $root.decideViewEachAllIssues.bind(this, member, stage),
                                        visible: member[stage]().length > 2">
                                            全てのタスクを表示 <span class="badge" data-bind="text: member[stage]().length"></span>
                                        </a>
                                    </div>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </div>
                    </li>
                <% } %>
            <% }); %>
        </ul>

    </div>

    <% include alert %>
</div>

<!-- Issue Detail Modal -->
<div class="modal fade" id="issue-detail-modal" tabindex="-1" role="dialog" aria-labelledby="issue-detail-modal-label" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="issue-detail-modal-label">Issue Detail</h4>
            </div>
            <form class="form">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="issue-detail-title" class="control-label">
                           <span class="glyphicon glyphicon-credit-card" aria-hidden="true"></span> タイトル
                        </label>
                        <input type="text" class="form-control" id="issue-detail-title" placeholder="Title"
                           data-bind="value: $root.updateIssueDetailTitle">
                    </div>

                    <div class="form-group">
                        <label for="issue-detail-body" class="control-label">
                            <span class="glyphicon glyphicon-align-left" aria-hidden="true"></span> 説明
                        </label>
                        <textarea class="form-control" rows="10" id="issue-detail-body" placeholder="Body"
                                  data-bind="value: $root.updateIssueDetailBody"></textarea>
                    </div>

                    <!-- ko if: $root.selectedIssue() -->
                    <!-- ko with: $root.selectedIssue() -->
                    <div class="form-group">
                        <label for="issue-detail-stage" class="control-label">
                            <span class="glyphicon glyphicon-road" aria-hidden="true"></span> Stage
                        </label>
                        <p class="form-control-static" id="issue-detail-stage" data-bind="text: stage"></p>
                    </div>

                    <div class="form-group">
                        <label for="issue-detail-assign" class="control-label">
                            <span class="glyphicon glyphicon-user" aria-hidden="true"></span> Assign
                        </label>
                        <p class="form-control-static" id="issue-detail-assign"
                           data-bind="text: assigneeMember() ? assigneeMember().userName : null"></p>
                    </div>

                    <div data-bind="if: github && github().url">
                        <a data-bind="attr: { href: github().url }">
                            <span class="glyphicon glyphicon-link" aria-hidden="true"></span> GitHub
                        </a>
                    </div>
                    <!-- /ko -->
                    <!-- /ko -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success" data-dismiss="modal"
                            data-bind="click: $root.updateIssueDetail">Update</button>
                </div>
            </form>

        </div>
    </div>
</div>

<!-- Add Issue Modal -->
<div class="modal fade" id="add-issue-modal" tabindex="-1" role="dialog" aria-labelledby="add-issue-modal-label" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="add-issue-modal-label">Add Issue</h4>
            </div>
            <form class="form">
                <div class="modal-body">
                    <p>
                        Issueを追加します。<br>
                        追加するIssue情報を入力してください。
                    </p>

                    <div class="form-group">
                        <label for="add-issue-title" class="control-label">
                            <span class="glyphicon glyphicon-credit-card" aria-hidden="true"></span> タイトル
                        </label>
                        <input type="text" class="form-control" id="add-issue-title" placeholder="Title"
                               data-bind="value: addIssueTitle" required>
                    </div>

                    <div class="form-group">
                        <label for="add-issue-body" class="control-label">
                            <span class="glyphicon glyphicon-align-left" aria-hidden="true"></span> 説明
                        </label>
                        <textarea class="form-control" rows="3" id="add-issue-body" placeholder="Body"
                               data-bind="value: addIssueBody"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success" data-dismiss="modal"
                            data-bind="click: addIssue">Add</button>
                </div>
            </form>

        </div>
    </div>
</div>

<!-- Assign Modal -->
<div class="modal fade" id="assign-issue-modal" tabindex="-1" role="dialog" aria-labelledby="assign-issue-modal-label" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="assign-issue-modal-label">Assign Issue</h4>
            </div>
            <form class="form">
                <div class="modal-body">
                    <p>
                        Issueをアサインします。<br>
                        アサイン情報情報を入力してください。
                    </p>

                    <div class="form-group">
                        <label for="assign-issue-title" class="control-label">
                            <span class="glyphicon glyphicon-credit-card" aria-hidden="true"></span> Issueのタイトル
                        </label>
                        <p class="form-control-static" id="assign-issue-title"
                           data-bind="text: $root.selectedIssue() && $root.selectedIssue().title"></p>
                    </div>

                    <div class="form-group">
                        <label for="assign-issue-body" class="control-label">
                            <span class="glyphicon glyphicon-align-left" aria-hidden="true"></span> Issueの説明
                        </label>
                        <p class="form-control-static" id="assign-issue-body"
                           data-bind="text: $root.selectedIssue() && $root.selectedIssue().body"></p>
                    </div>

                    <div class="form-group">
                        <label for="assign-issue-user" class="control-label">
                            <span class="glyphicon glyphicon-user" aria-hidden="true"></span> アサイン対象のユーザ名
                        </label>

                        <select class="form-control" id="assign-issue-user"
                                data-bind="options: $root.canAssignMembers,
                                optionsText: 'userName',
                                optionsValue: 'userName',
                                value: $root.assignUserName,
                                optionsCaption: '(no assignee)'" required>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success" data-dismiss="modal"
                            data-bind="click: $root.assignIssue">Assign</button>
                </div>
            </form>

        </div>
    </div>
</div>

<!-- Project Settings Modal -->
<div class="modal fade" id="project-settings-modal" tabindex="-1" role="dialog" aria-labelledby="project-settings-modal-label" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="project-settings-modal-label">Project settings</h4>
            </div>
            <div class="modal-body">
                <!-- ko with: $root.project -->
                <form class="form">
                    <div class="form-group">
                        <label for="project-settings-name" class="control-label">
                            <span class="glyphicon glyphicon-blackboard"> Name</span>
                        </label>
                        <p class="form-control-static" id="project-settings-name" data-bind="text: name"></p>
                    </div>

                    <!-- ko if: github() -->
                    <div class="form-group">
                        <label for="project-settings-github-link" class="control-label">
                            <span class="glyphicon glyphicon-link"> GitHub</span>
                        </label>
                        <p><a class="form-control-static" id="project-settings-github-link" target="_blank" data-bind="
                            text: github().userName() + '/' + github().repoName(),
                            attr: { href: github().url } "></a></p>
                    </div>

                    <div class="form-group">
                        <label for="project-settings-github-sync-enabled" class="control-label">
                            <span class="glyphicon glyphicon-blackboard"> 同期</span>
                        </label>
                        <p>
                            <!--<input class="switch" id="project-settings-github-sync-enabled" type="checkbox"-->
                                   <!--data-size="mini" data-bind="checked: github().sync">-->
                            <!-- ko if: $root.project.github().sync -->
                            <span class="label label-primary">同期ON</span>
                            <!-- /ko -->
                            <!-- ko ifnot: $root.project.github().sync -->
                            <span class="label label-default">同期OFF</span>
                            <!-- /ko -->
                            <span class="text-warning">現在システム上で変更できません。変更をしたい場合は管理者へお問い合わせください。</span>
                        </p>
                    </div>
                    <!-- /ko -->
                </form>
                <!-- /ko -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-success" data-dismiss="modal"
                        data-bind="click: $root.updateUserSettings">Update</button>
            </div>
        </div>
    </div>
</div>

<!-- Members Settings Modal -->
<div class="modal fade" id="members-settings-modal" tabindex="-1" role="dialog" aria-labelledby="members-settings-modal-label" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="members-settings-modal-label">Members settings</h4>
            </div>
            <div class="modal-body">
                <!-- ko with: $root.project -->
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>WIP</th>
                            <th>Order</th>
                            <th>Visible</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- ko foreach: members -->
                        <tr>
                            <td data-bind="text: userName"></td>
                            <td data-bind="text: wip() + '/' + wipLimit()"></td>
                            <td>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-xs btn-default" data-bind="click: $root.updateMemberOrderUp">
                                        <span class="glyphicon glyphicon-triangle-top"></span>
                                    </button>
                                    <button type="button" class="btn btn-xs btn-default" data-bind="click: $root.updateMemberOrderDown">
                                        <span class="glyphicon glyphicon-triangle-bottom"></span>
                                    </button>
                                </div>
                            </td>
                            <td>
                                <input type="checkbox" data-bind="checked: visible">
                            </td>
                        </tr>
                        <!-- /ko -->
                    </tbody>
                </table>

                <!-- Member Add -->
                <form class="form">
                    <div class="input-group">
                        <input type="text" class="form-control" id="add-member-username" placeholder="User Name"
                               data-bind="value: $root.addMemberUserName" required>
                        <span class="input-group-btn">
                            <button class="btn btn-default btn-success" type="submit" data-bind="click: $root.addMember">
                                <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>Add
                            </button>
                        </span>
                    </div>
                </form>

                <!-- /ko -->
            </div>
        </div>
    </div>
</div>

<!-- User Settings Modal -->
<div class="modal fade" id="user-settings-modal" tabindex="-1" role="dialog" aria-labelledby="user-settings-modal-label" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="user-settings-modal-label">User settings</h4>
            </div>
            <!-- ko if: $root.selectedMember -->
            <!-- ko with: $root.selectedMember -->
            <form class="form">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="user-settings-name" class="control-label">
                            <span class="glyphicon glyphicon-blackboard"> Name</span>
                        </label>
                        <p class="form-control-static" id="project-settings-user" data-bind="text: userName"></p>
                    </div>

                    <div class="form-group">
                        <label for="user-settings-wip" class="control-label">
                            <span class="glyphicon glyphicon-credit-card" aria-hidden="true"> 仕掛タスク数</span>
                        </label>
                        <p class="form-control-static" id="user-settings-wip">
                            <span data-bind="text: wip() + '/' + $root.settingsWipLimit()"></span>
                        </p>
                        <p class="alert alert-warning" data-bind="visible: wip() >= $root.settingsWipLimit()">
                            <span class="glyphicon glyphicon-warning-sign"></span> WIP制限に達しています。
                        </p>
                    </div>

                    <div class="form-group">
                        <label for="user-settings-wip-limit" class="control-label">
                            <span class="glyphicon glyphicon-credit-card" aria-hidden="true"> WIP制限数</span>
                        </label>
                        <input type="number" class="form-control" id="user-settings-wip-limit" placeholder="WIP Limit" min="0"
                               data-bind="value: $root.settingsWipLimit, valueUpdate: 'input'" required>
                        <p class="alert alert-danger" data-bind="visible: wip() > $root.settingsWipLimit()">
                            <span class="glyphicon glyphicon-warning-sign"></span> WIP制限を超過しています
                        </p>
                    </div>

                    <div class="form-group">
                        <button type="button" class="btn btn-danger remove-member-button" data-bind="click: $root.removeMember">
                            <span class="glyphicon glyphicon-trash" aria-hidden="true"></span> Delete
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success" data-dismiss="modal" data-bind="
                    click: $root.updateMember,
                    enable: wip() <= $root.settingsWipLimit()">
                        Update
                    </button>
                </div>
            </form>
            <!-- /ko -->
            <!-- /ko -->
        </div>
    </div>
</div>

<!-- view all issues -->
<div class="each-all-issues-view-area-wrap" data-bind="css: { show: $root.viewEachAllIssues }">
    <div class="each-all-issues-view-area-back"
         data-bind="click: $root.decideViewEachAllIssues.bind(null, null)"></div>
    <div class="each-all-issues-view-area" data-bind="click: $root.decideViewEachAllIssues.bind(null, null)">
        <!-- ko if: $root.viewEachAllIssues -->
        <!-- ko with: $root.viewEachAllIssues() -->
        <div class="each-all-issues-view-inner-area">
            <h3 class="each-all-issues-view-title" data-bind="text: member.userName() + '\'s ' + stage"></h3>

            <ul class="card-list" data-bind="
            foreach: {
                data: issues,
                afterRender: view.MiniMenu.init,
                afterAdd: view.effects.slideDown,
                beforeRemove: view.effects.slideUp }">
                <% include _card %>
            </ul>
        </div>
        <!-- /ko -->
        <!-- /ko -->
    </div>
</div>

<!-- include javascripts -->
<script src="/vendor/jquery/dist/jquery.min.js"></script>
<script src="/vendor/jquery.easing/js/jquery.easing.min.js"></script>
<script src="/vendor/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/vendor/bootstrap-switch/dist/js/bootstrap-switch.min.js"></script>
<script src="/vendor/lodash/lodash.min.js"></script>
<script src="/vendor/knockoutjs/dist/knockout.js"></script>
<script src="/socket.io/socket.io.js"></script>

<script src="/javascripts/module/util.js"></script>
<script src="/javascripts/model/Socket.js"></script>
<script src="/javascripts/model/stageTypes.js"></script>
<script src="/javascripts/model/Issue.js"></script>
<script src="/javascripts/model/User.js"></script>
<script src="/javascripts/model/Project.js"></script>
<script src="/javascripts/model/Projects.js"></script>
<script src="/javascripts/view/effects.js"></script>
<script src="/javascripts/view/miniMenu.js"></script>
<script src="/javascripts/view/scroller.js"></script>
<script src="/javascripts/viewmodel/Alert.js"></script>
<script src="/javascripts/viewmodel/Kanban.js"></script>
<script src="/javascripts/viewmodel/IssueDragAndDrop.js"></script>
<script src="/javascripts/viewmodel/ChainHideMembersWithURL.js"></script>
<script src="/javascripts/roots/kanban.js"></script>

</body>
</html>
